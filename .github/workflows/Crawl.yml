name: Crawling Internet

on:
  repository_dispatch:
    types: ["Crawl"]

jobs:
  scrape:
    runs-on: ubuntu-latest
    concurrency:
      group: crawl

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: "npm"
      - name: Get secrets
        run: |
          echo ${{ secrets.BOT_TOKEN }} > ./bot_token
          echo ${{ secrets.SOURCE }} > ./source
      - name: Install sing-box
        run: |
          mkdir ./bin
          curl "https://github.com/SagerNet/sing-box/releases/download/v1.1/sing-box-1.1-linux-amd64.tar.gz" -L -o ./bin/sing-box.tar.gz
          tar -xf ./bin/sing-box.zip -C ./bin
          rm -rf ./bin/sing-box.zip
          mv ./bin/sing-box-1.1-linux-amd64/* ./bin/
      - name: Start Crawling
        env:
          DATA: ${{ github.event.client_payload.message }}
        run: |
          npm install && npx tsc && node ./app/index.js $DATA
      - name: Add & Commit
        if: ${{ success() }}
        uses: EndBug/add-and-commit@v9
        with:
          add: '["./result", "./resources/database"]'
          default_author: github_actions
          fetch: false
          tag_push: "--force"
          message: "Update VPN"
      - name: Scavenge next source
        if: ${{ always() }}
        run: |
          curl ${{ secrets.SOURCE }} -L
